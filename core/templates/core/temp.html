{% extends 'core/base.html' %}
{% block content %}
<h2>ðŸ“¦ Your Capsules</h2>

{% for msg in messages %}
    <li>
        <strong>{{ msg.heading }}</strong><br>
        Created: {{ msg.created_at|date:"Y-m-d H:i" }}<br>
        Unlocks: {{ msg.unlock_datetime|date:"Y-m-d H:i" }}<br>

        {% if msg.remaining > 0 %}
            <span id="countdown-{{ forloop.counter }}"></span>
            <script>
                const countdown{{ forloop.counter }} = document.getElementById("countdown-{{ forloop.counter }}");
                let seconds = Math.floor({{ msg.remaining }});

                function formatTime(sec) {
                    const d = Math.floor(sec / (3600 * 24));
                    sec %= 3600 * 24;
                    const h = Math.floor(sec / 3600);
                    sec %= 3600;
                    const m = Math.floor(sec / 60);
                    const s = Math.floor(sec % 60);
                    return `${d}d ${h}h ${m}m ${s}s`;
                }

                setInterval(() => {
                    if (seconds > 0) {
                        countdown{{ forloop.counter }}.textContent = "Unlocks in: " + formatTime(seconds--);
                    } else {
                        countdown{{ forloop.counter }}.textContent = "ðŸŸ¢ Unlocked!";
                    }
                }, 1000);
            </script>
        {% else %}
            âœ… <strong>Unlocked</strong>
            <p>{{ msg.content }}</p>

            {% if msg.image %}
                <img src="{{ msg.image.url }}" alt="Message Image" style="max-width: 300px;">
            {% endif %}

            {% if msg.video %}
                <video controls style="max-width: 500px;">
                    <source src="{{ msg.video.url }}">
                    Your browser does not support the video tag.
                </video>
            {% endif %}

            {% if msg.file %}
                <a href="{{ msg.file.url }}" download>Download attached file</a>
            {% endif %}
        {% endif %}
    </li>
    <hr>
{% endfor %}

{% endblock %}
